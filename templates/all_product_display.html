{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
{% include 'includes/header.html' %}


<!-- ========================= SECTION PAGETOP ========================= -->
<style>
    .line-clamp {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2; /* Change this line if you want. In this case it trimmed the text to 3 lines. */
        overflow: hidden;
      }
</style>


<section class="section-pagetop bg">
    <div class="container">
        {% include 'includes/alerts.html' %}
        {% if 'search' in request.path %}
        <h2 class="title-page">Search Result</h2>
        {% else %}
        <h2 class="title-page">Our Store</h2>
        {% endif %}
        
    </div> <!-- container //  -->
    </section>
    <!-- ========================= SECTION INTRO END// ========================= -->
    
    <!-- ========================= SECTION CONTENT ========================= -->
    <section class="section-content padding-y">
    <div class="container">
    
    <div class="row">
        <aside class="col-md-3">
            <div class="card">
                <article class="filter-group">
                    <header class="card-header bg-secondary">
                        <a href="#" data-toggle="collapse" data-target="#collapse_1" aria-expanded="true" class="text-decoration-none text-light">
                            <i class="icon-control fa fa-chevron-down"></i>
                            <h6 class="title">Categories</h6>
                        </a>
                    </header>
                    <div class="filter-content collapse show" id="collapse_1">
                        <div class="card-body filter-inner-style">
                            
                            <ul class="list-menu">
                                {% for category in all_categories_list %}
                                    {% if not category.parent %}
                                    <li>
                                        <a href="{{category.get_url}}" class="">
                                            <h6 class="d-inline-block">{{category.category_name}}</h6>
                                        </a>
                                        <a href="" data-toggle="collapse" data-target="#collapse_sub{{forloop.counter}}" aria-expanded="true">
                                            <i class="icon-control fa fa-chevron-down float-right"></i>
                                        </a>
                                        
                                        <div class="filter-content collapse" id="collapse_sub{{forloop.counter}}">
                                            <div class="card-body">
                                                <ul class="list-menu">
                                                    {% for subcategory in all_categories_list %}
                                                    {% if subcategory.parent == category %}
                                                    <li class="bg-dark p-2 rounded">
                                                        <a href="{{subcategory.get_url}}" class="text-light">
                                                            {{subcategory.category_name}}
                                                        </a>
                                                    </li>
                                                    {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                                
                            </div> <!-- card-body.// -->
                        </div>
                    </article> <!-- filter-group  .// -->
                    
                    
                    {% for attribute in all_attribute_list %}
                    <article class="filter-group">
                        <header class="card-header bg-secondary">
                            <a href="#" data-toggle="collapse" data-target="#collapse_color" aria-expanded="true" class="text-decoration-none text-light">
                                <i class="icon-control fa fa-chevron-down"></i>
                                <h6 class="title">{{attribute.attribute_name}} </h6>
                            </a>
                        </header>
                    <div class="filter-content collapse" id="collapse_{{attribute.attribute_name}}">
                        <div class="card-body">
                            <ul class="list-menu">
                                {% for value in attribute.attributevalue_set.all %}
                                    {% if value.is_active %}
                                        <li>
                                            <label class="checkbox-btn my-1 ">
                                                <input type="checkbox" class="filter-checkbox" value="{{attribute.attribute_name}}={{value.attribute_value}}">
                                                <span class="btn btn-light text-left" style="width: 150px;">{{value.attribute_value}}</span>
                                            </label>
                                        </li>
                                    {% endif %} 
                                {% empty %}
                                    <p>-</p>
                                {% endfor %}
                            </ul>
                        </div>
                        <!-- card-body.// -->
                    </div>
                </article>
                {% endfor %}

                <article class="filter-group">
                    <header class="card-header bg-secondary">
                        <a href="#" data-toggle="collapse" data-target="#collapse_price_range" aria-expanded="true" class="text-decoration-none text-light">
                            <i class="icon-control fa fa-chevron-down"></i>
                            <h6 class="title">Price range </h6>
                        </a>
                    </header>
                    <div class="filter-content collapse show" id="collapse_price_range">
                        <div class="card-body">
                            
                            <div class="form-row">
                            <div class="form-group col-md-6">
                              <label>Min</label>
                              <input class="form-control" placeholder="Rs 0" type="number" id="filter-price-range-min" value="{% if price_min %}{{ price_min }}{% endif %}">
                                
                            </div>
                            <div class="form-group  col-md-6">
                              <label>Max</label>
                              <input class="form-control" placeholder="Rs 5,000,00" type="number" id="filter-price-range-max" value="{% if price_max %}{{ price_max }}{% endif %}">
                            </div>
                            </div> <!-- form-row.// -->
                            <button class="btn btn-block btn-dark my-2" onclick="filterWithPriceRange('filter-price-range-min','filter-price-range-max')">Apply</button>
                        </div><!-- card-body.// -->
                    </div>
                </article> <!-- filter-group .// -->
                <!-- filter-group .// -->
                
                
            </div> <!-- card.// -->
    
        </aside> <!-- col.// -->
        <main class="col-md-9">
    
    <header class="border-bottom mb-4 pb-3">
            <div class="form-inline">
                <span class="mr-md-auto">{{product_variants_count}} Items found </span>
                
            </div>
    </header><!-- sect-heading -->
    {% if not product_variants_count %}
        <img src="{% static 'accounts/images/items/noproductfound.jpg' %}" class="mw-100"/>
    {% endif %}
    <div class="row">
        {% if product_variants %}
        {% for variant in product_variants %}
        <div class="col-md-4 px-3 py-2">
            <figure class="card card-product-grid">
                <!-- offer -->
                <div class="m-2 position-absolute" style="z-index: 2; top: 0; right: 0;">
                    {% if variant.product_offer.offer_percentage != 0 %}
                        <button type="button" class="btn btn-danger m-0 ">
                            -{{ variant.product_offer.offer_percentage }}%
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bookmark-star" viewBox="0 0 16 16">
                                <path d="M7.84 4.1a.178.178 0 0 1 .32 0l.634 1.285a.178.178 0 0 0 .134.098l1.42.206c.145.021.204.2.098.303L9.42 6.993a.178.178 0 0 0-.051.158l.242 1.414a.178.178 0 0 1-.258.187l-1.27-.668a.178.178 0 0 0-.165 0l-1.27.668a.178.178 0 0 1-.257-.187l.242-1.414a.178.178 0 0 0-.05-.158l-1.03-1.001a.178.178 0 0 1 .098-.303l1.42-.206a.178.178 0 0 0 .134-.098L7.84 4.1z"></path>
                                <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"></path>
                            </svg>
                        </button>
                    {% endif %} 
                </div>
                <a href="{{variant.get_url}}">
                    <div class="img-wrap p-4 product_card">
                        <img src="{{variant.thumbnail_image.url}}">
                    </div> <!-- img-wrap.// -->
                </a>
                <figcaption class="info-wrap">
                    <div class="fix-height">
                        <a href="{{variant.get_url}}" class="title">
                            <p class="line-clamp m-0 p-0">
                                {{variant.get_product_name|slice:80}}...
                            </p>
                        </a>
                        <div class="price-wrap mt-2">
                            <span class="price">
                                &#8377; {{variant.product_price|intcomma}}
                            </span>
                            <del class="price-old">&#8377; {{ variant.max_price|intcomma }}</del>

                        </div> <!-- price-wrap.// -->
                    </div>
                    {% if variant.stock <= 0 %}
                    <h5 class="text text-danger">Out of stock</h5>
                    {% else %}
                    <a href="{% url 'add_cart' variant.id %}" class="btn btn-primary"><span class="text">Add to cart</span> <i class="fas fa-shopping-cart"></i>  </a>
                    {% endif %}
                </figcaption>
            </figure>
        </div> <!-- col.// -->
        {% endfor %}
        {% endif %}
    </div> <!-- row end.// -->
    
    {% if product_variants.has_other_pages %}
    <nav class="mt-4" aria-label="Page navigation sample">
      <ul class="pagination">
        {% if product_variants.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{product_variants.previous_page_number}}">Previous</a></li>
        {% else %}
        <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
        {% endif %}

        {% for i in product_variants.paginator.page_range %}
            {% if product_variants.number == i %}
                <li class="page-item active"><a class="page-link" href="#">{{i}}</a></li>
            {% else %}
                <li class="page-item "><a class="page-link" href="?page={{i}}">{{i}}</a></li>
            {% endif %}
        {% endfor %}

        {% if product_variants.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{product_variants.next_page_number}}">Next</a></li>
        {% else %}
        <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
        {% endif %}
    </ul>
    </nav>
    {% endif %}
    
        </main> <!-- col.// -->
    
    </div>
    
    </div> <!-- container .//  -->
    </section>
    <!-- ========================= SECTION CONTENT END// ========================= -->
    <script>
        // Get all the checkbox inputs
        const checkboxes = document.querySelectorAll('input.filter-checkbox[type="checkbox"]');
        console.log("print0  :", checkboxes.length);

        // Set the initial active state of checkboxes based on the URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        console.log("dfsjgf ",urlParams.getAll("color"));
        console.log("the urlParams:  ",window.location.search);
        checkboxes.forEach(checkbox => {
            const paramName = checkbox.value.split('=')[0];
            const paramValue = checkbox.value.split('=')[1];
            
            console.log("all paramName:  ",urlParams.getAll(paramName));
        if (urlParams.has(paramName) && urlParams.getAll(paramName).includes(paramValue)) {
            checkbox.checked = true;
        }
        
        console.log(checkbox.parentNode);
        checkbox.parentNode.classList.add('active');
        });

        // Handle checkbox click event
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function() {
            
                const paramName = this.value.split('=')[0];
                const paramValue = this.value.split('=')[1];
                const urlParams = new URLSearchParams(window.location.search);
                // Check if checkbox is checked or unchecked
                if (this.checked) {
                    // Get existing parameter value(s) and append the new value
                    const existingValues = urlParams.getAll(paramName);
                    existingValues.push(paramValue);
                    urlParams.delete(paramName);
                    existingValues.forEach(value => urlParams.append(paramName, value));
                } else {
                    // Remove the specific value from the parameter
                    const existingValues = urlParams.getAll(paramName);
                    const updatedValues = existingValues.filter(value => value !== paramValue);
                    urlParams.delete(paramName);
                    updatedValues.forEach(value => urlParams.append(paramName, value));
                }
                
                // Update the URL with the modified parameters
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState(null, '', newUrl);
                // history.pushState(null, '', newUrl);

                // Reload the page with the updated URL
                window.location.href = newUrl;
            });
        });


    </script>
                                                              
    {% endblock %}